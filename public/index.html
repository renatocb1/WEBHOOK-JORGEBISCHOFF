<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enviar WhatsApp - API Oficial</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      color: #e6edf3;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .cards-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 2rem;
      width: 100%;
      max-width: 1100px;
    }
    .card {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 2rem;
      flex: 1 1 320px;
      min-width: 0;
      max-width: 420px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .card h1, .card h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      font-weight: 600;
      line-height: 1.3;
    }
    h1, .card-title-with-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h1::before, .card-title-with-logo::before {
      content: '';
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2325D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>') center/contain no-repeat;
    }
    .sub {
      color: #8b949e;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.35rem;
      color: #c9d1d9;
    }
    input, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #0d1117;
      color: #e6edf3;
      font-size: 1rem;
    }
    input::placeholder, textarea::placeholder { color: #6e7681; }
    input:focus, textarea:focus {
      outline: none;
      border-color: #25D366;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    button {
      width: 100%;
      padding: 0.85rem 1rem;
      background: #25D366;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.05s;
    }
    button:hover { background: #20bd5a; }
    button:active { transform: scale(0.98); }
    button:disabled {
      background: #30363d;
      color: #8b949e;
      cursor: not-allowed;
      transform: none;
    }
    .feedback {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      display: none;
    }
    .feedback.success {
      display: block;
      background: rgba(35, 134, 54, 0.2);
      border: 1px solid #238636;
      color: #3fb950;
    }
    .feedback.error {
      display: block;
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid #f85149;
      color: #f85149;
    }
    .hint {
      font-size: 0.75rem;
      color: #6e7681;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }
    .option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .option input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .option span { margin-bottom: 0; }
    .bulk-summary {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      background: #0d1117;
      border: 1px solid #30363d;
      max-height: 200px;
      overflow-y: auto;
    }
    .bulk-summary .row { padding: 0.25rem 0; }
    .bulk-summary .fail { color: #f85149; }
    .bulk-summary .ok { color: #3fb950; }
    input[type="file"] {
      padding: 0.5rem 0;
      margin-bottom: 1rem;
    }
    input[type="file"]::file-selector-button {
      padding: 0.4rem 0.75rem;
      margin-right: 0.5rem;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #21262d;
      color: #c9d1d9;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="cards-container">
  <div class="card">
    <h1>Enviar WhatsApp</h1>
    <p class="sub">API oficial Meta (WhatsApp Business)</p>

    <label for="phone">Número (com DDI, sem + ou espaços)</label>
    <input type="text" id="phone" placeholder="Ex: 5511999999999" inputmode="numeric">
    <p class="hint">Brasil: 55 + DDD + número (9 dígitos)</p>

    <label for="message">Mensagem</label>
    <textarea id="message" placeholder="Digite sua mensagem..."></textarea>
    <p class="hint">Obrigatório se não anexar PDF. Com PDF, vira legenda.</p>

    <label for="document">Anexar PDF (opcional)</label>
    <input type="file" id="document" accept="application/pdf,.pdf">
    <p class="hint">Inclua um PDF para enviar como documento. Máx. 16 MB.</p>

    <button type="button" id="btnSend">Enviar</button>

    <div id="feedback" class="feedback"></div>
  </div>

  <div class="card card-bulk">
    <h2 class="card-title card-title-with-logo">Envio em massa</h2>
    <p class="sub">Um contato por linha: nome;telefone</p>

    <label for="contacts">Contatos (nome;telefone)</label>
    <textarea id="contacts" placeholder="João Silva;5511999999999&#10;Maria Santos;5521988887777&#10;Pedro;5531977776666" rows="6"></textarea>
    <p class="hint">Formato: nome;número (com DDI, sem + ou espaços). Linhas em branco são ignoradas.</p>

    <label for="messageBulk">Mensagem (legenda se anexar PDF)</label>
    <textarea id="messageBulk" placeholder="Ex: Olá, $nome! Temos novidades para você." rows="3"></textarea>
    <p class="hint">Use <strong>$nome</strong> no texto para substituir pelo nome de cada contato (da coluna nome;telefone).</p>

    <label for="documentBulk">Anexar PDF (opcional)</label>
    <input type="file" id="documentBulk" accept="application/pdf,.pdf">
    <p class="hint">O mesmo PDF será enviado para todos os contatos.</p>

    <button type="button" id="btnBulk">Enviar em massa</button>

    <div id="feedbackBulk" class="feedback"></div>
    <div id="bulkSummary" class="bulk-summary" style="display:none;"></div>
  </div>

  <div class="card">
    <h2 class="card-title card-title-with-logo">Mensagem inicial (catálogo)</h2>
    <p class="sub">Estilo Jasper Market: envia mensagem com botão &quot;Ver Catálogo PDF&quot;; ao clicar, o PDF é enviado automaticamente</p>

    <label for="phoneCatalog">Número (com DDI, sem + ou espaços)</label>
    <input type="text" id="phoneCatalog" placeholder="Ex: 5511999999999" inputmode="numeric">
    <p class="hint">Brasil: 55 + DDD + número (9 dígitos)</p>

    <label for="headerCatalog">Cabeçalho (opcional)</label>
    <input type="text" id="headerCatalog" placeholder="Ex: Bem-vindo ao nosso catálogo!">
    <p class="hint">Título da mensagem interativa.</p>

    <label for="messageCatalog">Texto da mensagem (corpo)</label>
    <textarea id="messageCatalog" placeholder="Gostaria de conferir nossas ofertas? Clique no botão abaixo para receber o catálogo em PDF." rows="2"></textarea>
    <p class="hint">Texto principal. Se vazio, usa um texto padrão.</p>

    <label for="footerCatalog">Rodapé (opcional)</label>
    <input type="text" id="footerCatalog" placeholder="Clique no botão abaixo para baixar.">
    <p class="hint">Pequeno texto abaixo do botão.</p>

    <label for="documentCatalog">PDF do catálogo (obrigatório)</label>
    <input type="file" id="documentCatalog" accept="application/pdf,.pdf">
    <p class="hint">Salvo no servidor; será enviado ao cliente quando ele clicar em &quot;Ver Catálogo PDF&quot;. Configure o webhook na Meta. Máx. 16 MB.</p>

    <button type="button" id="btnCatalog">Enviar mensagem com botão</button>

    <div id="feedbackCatalog" class="feedback"></div>
  </div>
  </div>

  <script>
    const phoneInput = document.getElementById('phone');
    const messageInput = document.getElementById('message');
    const documentInput = document.getElementById('document');
    const btnSend = document.getElementById('btnSend');
    const feedback = document.getElementById('feedback');

    function showFeedback(text, isError) {
      feedback.textContent = text;
      feedback.className = 'feedback ' + (isError ? 'error' : 'success');
      feedback.style.display = 'block';
    }

    async function enviar() {
      const to = phoneInput.value.trim();
      const message = messageInput.value.trim();
      const hasFile = documentInput.files && documentInput.files.length > 0;

      if (!to) {
        showFeedback('Preencha o número.', true);
        return;
      }
      if (!message && !hasFile) {
        showFeedback('Preencha a mensagem ou anexe um PDF.', true);
        return;
      }

      btnSend.disabled = true;
      feedback.style.display = 'none';

      try {
        let res;
        if (hasFile) {
          const form = new FormData();
          form.append('to', to);
          form.append('message', message);
          form.append('document', documentInput.files[0]);
          res = await fetch('/send-message', { method: 'POST', body: form });
        } else {
          res = await fetch('/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, message: message || undefined })
          });
        }

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          showFeedback('Mensagem enviada com sucesso!');
          messageInput.value = '';
          documentInput.value = '';
        } else {
          const msg = data.error?.message || data.error?.error_user_msg || JSON.stringify(data.error || data) || 'Erro ao enviar.';
          showFeedback(msg, true);
        }
      } catch (err) {
        showFeedback('Erro de conexão. O servidor está rodando?', true);
      } finally {
        btnSend.disabled = false;
      }
    }

    btnSend.addEventListener('click', enviar);
    messageInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') enviar();
    });

    // Envio em massa
    const contactsInput = document.getElementById('contacts');
    const messageBulkInput = document.getElementById('messageBulk');
    const documentBulkInput = document.getElementById('documentBulk');
    const btnBulk = document.getElementById('btnBulk');
    const feedbackBulk = document.getElementById('feedbackBulk');
    const bulkSummary = document.getElementById('bulkSummary');

    function showFeedbackBulk(text, isError) {
      feedbackBulk.textContent = text;
      feedbackBulk.className = 'feedback ' + (isError ? 'error' : 'success');
      feedbackBulk.style.display = 'block';
      bulkSummary.style.display = 'none';
    }

    async function enviarBulk() {
      const contacts = contactsInput.value.trim();
      const message = messageBulkInput.value.trim();
      const hasFile = documentBulkInput.files && documentBulkInput.files.length > 0;

      if (!contacts) {
        showFeedbackBulk('Cole a lista de contatos (nome;telefone, um por linha).', true);
        return;
      }
      if (!message && !hasFile) {
        showFeedbackBulk('Preencha a mensagem ou anexe um PDF.', true);
        return;
      }

      btnBulk.disabled = true;
      feedbackBulk.style.display = 'none';
      bulkSummary.style.display = 'none';

      try {
        let res;
        if (hasFile) {
          const form = new FormData();
          form.append('contacts', contacts);
          form.append('message', message);
          form.append('document', documentBulkInput.files[0]);
          res = await fetch('/send-bulk', { method: 'POST', body: form });
        } else {
          res = await fetch('/send-bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contacts, message: message || undefined })
          });
        }
        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          const { total, success, failed, results } = data;
          showFeedbackBulk(`Envio em massa: ${success} enviada(s), ${failed} falha(s) de ${total} contato(s).`, failed > 0 && success > 0 ? 'error' : false);
          if (results && results.length) {
            bulkSummary.style.display = 'block';
            bulkSummary.innerHTML = results.map(r => {
              const label = (r.name ? r.name + ' – ' : '') + r.phone;
              return r.success
                ? '<div class="row ok">✓ ' + label + '</div>'
                : '<div class="row fail">✗ ' + label + ': ' + (r.error || 'erro') + '</div>';
            }).join('');
          }
          documentBulkInput.value = '';
        } else {
          showFeedbackBulk(data.error || 'Erro ao enviar em massa.', true);
        }
      } catch (err) {
        showFeedbackBulk('Erro de conexão. O servidor está rodando?', true);
      } finally {
        btnBulk.disabled = false;
      }
    }

    btnBulk.addEventListener('click', enviarBulk);

    // Mensagem inicial (catálogo) – estilo Jasper Market: botão → webhook → envio do PDF
    const phoneCatalogInput = document.getElementById('phoneCatalog');
    const headerCatalogInput = document.getElementById('headerCatalog');
    const messageCatalogInput = document.getElementById('messageCatalog');
    const footerCatalogInput = document.getElementById('footerCatalog');
    const documentCatalogInput = document.getElementById('documentCatalog');
    const btnCatalog = document.getElementById('btnCatalog');
    const feedbackCatalog = document.getElementById('feedbackCatalog');

    function showFeedbackCatalog(text, isError) {
      feedbackCatalog.textContent = text;
      feedbackCatalog.className = 'feedback ' + (isError ? 'error' : 'success');
      feedbackCatalog.style.display = 'block';
    }

    async function enviarCatalog() {
      const to = phoneCatalogInput.value.trim();
      const header = headerCatalogInput.value.trim();
      const message = messageCatalogInput.value.trim();
      const footer = footerCatalogInput.value.trim();
      const file = documentCatalogInput.files && documentCatalogInput.files[0];

      if (!to) {
        showFeedbackCatalog('Preencha o número.', true);
        return;
      }
      if (!file) {
        showFeedbackCatalog('Selecione o PDF do catálogo.', true);
        return;
      }

      btnCatalog.disabled = true;
      feedbackCatalog.style.display = 'none';

      try {
        const form = new FormData();
        form.append('to', to);
        if (header) form.append('header', header);
        form.append('message', message);
        if (footer) form.append('footer', footer);
        form.append('catalog', file);
        const res = await fetch('/send-initial-message', { method: 'POST', body: form });
        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          showFeedbackCatalog('Mensagem com botão enviada! Quando o cliente clicar em "Ver Catálogo PDF", o PDF será enviado (webhook).');
          messageCatalogInput.value = '';
          headerCatalogInput.value = '';
          footerCatalogInput.value = '';
          documentCatalogInput.value = '';
        } else {
          const msg = data.error?.message || data.error?.error_user_msg || JSON.stringify(data.error || data) || 'Erro ao enviar.';
          showFeedbackCatalog(msg, true);
        }
      } catch (err) {
        showFeedbackCatalog('Erro de conexão. O servidor está rodando?', true);
      } finally {
        btnCatalog.disabled = false;
      }
    }

    btnCatalog.addEventListener('click', enviarCatalog);
  </script>
</body>
</html>
